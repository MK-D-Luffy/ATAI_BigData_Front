<template>
  <article class="col-7 fl" style="background-color:#fff">
    <div class="u-r-cont">
      <section>
        <div>
          <section class="c-infor-tabTitle c-tab-title">
            <a href="javascript: void(0)" title="Âü∫Êú¨ËµÑÊñô" class="current">
              ‰∏™‰∫∫‰ø°ÊÅØ
            </a>
          </section>
        </div>

        <!-- Ë°®Ê†º -->
        <el-form show-message label-width="80px" size="medium" :model="memberInfo" ref="memberInfo">
          <el-form-item label="ÊòµÁß∞" prop="nickname" :rules="[{validator:checkNickname,trigger:'blur'}]">
            <el-input v-model="memberInfo.nickname" style="width:220px"/>
          </el-form-item>
          <el-form-item label="ÊÄßÂà´">
            <el-select v-model="memberInfo.sex" style="width:110px" clearable placeholder="ËØ∑ÈÄâÊã©">
              <!--
                Êï∞ÊçÆÁ±ªÂûã‰∏ÄÂÆöË¶ÅÂíåÂèñÂá∫ÁöÑjson‰∏≠ÁöÑ‰∏ÄËá¥ÔºåÂê¶ÂàôÊ≤°Ê≥ïÂõûÂ°´
                value‰ΩøÁî®Âä®ÊÄÅÁªëÂÆöÁöÑÂÄºÔºåÊÄßÂà´Áî±1 2‰ª£Êõø
              -->
              <el-option :value="1" label="Â•≥"/>
              <el-option :value="2" label="Áî∑"/>
            </el-select>
          </el-form-item>
          <el-form-item label="ÊâãÊú∫Âè∑">
            <!--            <el-input v-model="memberInfo.mobile"/>-->
            <span>{{ memberInfo.mobile.substring(0, 3) + "****" + memberInfo.mobile.substring(7, 11) }}</span>
            <el-button @click="mobileDialogVisible = true" style="margin-left:45px" type="primary">‰øÆÊîπÊâãÊú∫Âè∑Á†Å</el-button>
          </el-form-item>
          <el-form-item label="ÈÇÆÁÆ±">
            <!--            <el-input v-model="memberInfo.email"/>-->
            <span>{{ memberInfo.email.substring(0, 2) + "****" + memberInfo.email.substring(10) }}</span>
            <el-button @click="emailDialogVisible = true" style="margin-left:24px" type="primary">‰øÆÊîπÈÇÆÁÆ±</el-button>
          </el-form-item>
          <el-form-item label="Âπ¥ÈæÑ">
            <el-input-number style="width:180px" v-model="memberInfo.age" :min="0" controls-position="right"/>
          </el-form-item>

          <el-form-item label="Â≠¶ÂéÜ">
            <el-select style="width:180px" v-model="memberInfo.education" clearable placeholder="ËØ∑ÈÄâÊã©">
              <el-option
                v-for="item in educationOptions"
                :key="item.value"
                :label="item.label"
                :value="item.value"
              >
              </el-option>
            </el-select>
          </el-form-item>

          <!-- Â§¥ÂÉè -->
          <el-form-item label="Â§¥ÂÉè">
            <el-upload
              :show-file-list="true"
              :on-success="handleAvatarSuccess"
              :on-error="handleAvatarError"
              :before-upload="beforeAvatarUpload"
              class="avatar-uploader"
              action=" https://baiyunrain.mynatapp.cc/eduoss/fileoss">
              <img v-if="memberInfo.avatar" :src="memberInfo.avatar">
              <i v-else class="el-icon-plus avatar-uploader-icon"/>
              <div slot="tip" class="el-upload__tip">Âè™ËÉΩ‰∏ä‰º†jpg/pngÊñá‰ª∂Ôºå‰∏î‰∏çË∂ÖËøá1MB</div>
            </el-upload>
          </el-form-item>
          <el-form-item label="‰∏™ÊÄßÁ≠æÂêç">
            <el-input
              style="width:600px"
              type="textarea"
              :autosize="{ minRows: 4, maxRows: 8}"
              placeholder="ËØ∑ËæìÂÖ•ÂÜÖÂÆπ"
              v-model="memberInfo.sign">
            </el-input>
          </el-form-item>

          <el-form-item style="margin-top: 40px;margin-bottom: 40px">
            <el-button :disabled="saveBtnDisabled" plain="true" type="primary" @click="saveMsg">‰øùÂ≠ò</el-button>
          </el-form-item>
        </el-form>

        <!--ÂÆâÂÖ®È™åËØÅ-->
        <el-dialog :close-on-click-modal="false" width="36%" center title="ÂÆâÂÖ®ÊÄßÈ™åËØÅ" :visible.sync="validateDialogVisible">
          <el-form label-position="right" label-width="100px" :model="validateParams">
            <el-form-item label="ÊâãÊú∫Âè∑Á†Å" prop="mobile"
                          :rules="[{ required: true, message: 'ËØ∑ËæìÂÖ•ÊâãÊú∫Âè∑Á†Å', trigger: 'blur' },{validator: checkPhone, trigger: 'blur'}]">
              <el-input style="width:64%;margin-right: 12px" v-model="validateParams.mobile"></el-input>
              <el-button :disabled="!sending" type="primary" @click="getCodeFun('1')">{{
                  codeTest
                }}
              </el-button>
            </el-form-item>
            <el-form-item label="È™åËØÅÁ†Å">
              <el-input style="width:64%" v-model="validateParams.code"></el-input>
            </el-form-item>
          </el-form>
          <div slot="footer" class="dialog-footer">
            <el-button @click="validateDialogVisible = false">Âèñ Ê∂à</el-button>
            <el-button type="primary" @click="validateSecurity()">Á°Æ ÂÆö</el-button>
          </div>
        </el-dialog>

        <!--‰øÆÊîπÊâãÊú∫Âè∑-->
        <el-dialog :close-on-click-modal="false" width="36%" center title="ÊâãÊú∫Âè∑Á†ÅÈ™åËØÅ" :visible.sync="mobileDialogVisible">
          <el-form label-position="right" label-width="100px" :model="params">
            <el-form-item label="ÊâãÊú∫Âè∑Á†Å" prop="mobile"
                          :rules="[{ required: true, message: 'ËØ∑ËæìÂÖ•ÊâãÊú∫Âè∑Á†Å', trigger: 'blur' },{validator: checkPhone, trigger: 'blur'}]">
              <el-input style="width:64%;margin-right: 12px" v-model="params.mobile"></el-input>
              <el-button :disabled="!sending" type="primary" @click="getCodeFun('1')">{{
                  codeTest
                }}
              </el-button>
            </el-form-item>
            <el-form-item label="È™åËØÅÁ†Å">
              <el-input style="width:64%" v-model="params.code"></el-input>
            </el-form-item>
          </el-form>
          <div slot="footer" class="dialog-footer">
            <el-button @click="mobileDialogVisible = false">Âèñ Ê∂à</el-button>
            <el-button type="primary" @click="saveMobileOrEmail('1')">Á°Æ ÂÆö</el-button>
          </div>
        </el-dialog>

        <!--‰øÆÊîπÈÇÆÁÆ±-->
        <el-dialog :close-on-click-modal="false" width="36%" center title="ÈÇÆÁÆ±È™åËØÅ" :visible.sync="emailDialogVisible">
          <el-form label-position="right" label-width="100px" :model="params">
            <el-form-item label="ÈÇÆÁÆ±Ôºö" prop="email"
                          :rules="[{ required: true, message: 'ËØ∑ËæìÂÖ•ÈÇÆÁÆ±', trigger: 'blur' },{validator: checkEmail, trigger: 'blur'}]">
              <el-input style="width:64%;margin-right:12px" v-model="params.email"
                        autocomplete="off"></el-input>
              <el-button :disabled="!sending" type="primary" @click="getCodeFun('2')">{{
                  codeTest
                }}
              </el-button>
            </el-form-item>
            <el-form-item label="È™åËØÅÁ†ÅÔºö" prop="code">
              <el-input style="width:64%" v-model="params.code"></el-input>
            </el-form-item>
          </el-form>
          <div slot="footer" class="dialog-footer">
            <el-button @click="emailDialogVisible = false">Âèñ Ê∂à</el-button>
            <el-button type="primary" @click="saveMobileOrEmail('2')">Á°Æ ÂÆö</el-button>
          </div>
        </el-dialog>

      </section>
    </div>
  </article>
</template>
<script>
//ÂºïÂÖ•Ë∞ÉÁî®login.jsÊñá‰ª∂
import loginApi from '@/api/login'
//ÂºïÂÖ•Ë∞ÉÁî®ucenter.jsÊñá‰ª∂
import ucenterApi from '@/api/ucenter'
//ÂºïÂÖ•Ë∞ÉÁî®js-cookie
import cookie from 'js-cookie'
import registerApi from "@/api/register";
import error from "@/layouts/error";

export default {
  inject: ['reload'],
  data() {
    return {
      token: '',
      loginInfo: {
        id: '',
        nickname: '',
        avatar: '',
      },
      memberInfo: {
        id: '',
        age: '',
        avatar: '',
        education: '',
        mobile: '',
        email: '',
        nickname: '',
        sex: '',
        sign: '',
      },
      educationOptions: [],
      saveBtnDisabled: false, //‰øùÂ≠òÊåâÈíÆÊòØÂê¶Á¶ÅÁî®
      mobileDialogVisible: false,
      emailDialogVisible: false,
      codeType: "2",
      sending: true, //ÊòØÂê¶ÂèëÈÄÅÈ™åËØÅÁ†Å
      second: 60, //ÂÄíËÆ°Êó∂Èó¥
      codeTest: 'Ëé∑ÂèñÈ™åËØÅÁ†Å',
      validateMobile: false,
      validateEmail: false,
      //Áî®‰∫é‰øÆÊîπÁªëÂÆöÊâãÊú∫Âè∑ÊàñÈÇÆÁÆ±
      params: {
        mobile: '',
        email: '',
        code: ''
      },
      //Áî®‰∫éËøõË°åÂÆâÂÖ®ÊÄßÈ™åËØÅ
      validateParams: {
        mobile: '',
        code: ''
      },

    }
  },

  created() {
    //Ëé∑ÂèñË∑ØÂæÑÈáåÈù¢tokenÂÄº
    this.token = this.$route.query.token
    // if (this.token) {//Âà§Êñ≠Ë∑ØÂæÑÊòØÂê¶ÊúâtokenÂÄº
    //   this.wxLogin()
    // }
    this.updateEducationOption();
    this.showInfoFromCookie()
  },

  methods: {
    //ÊØèÂπ¥Êõ¥Êñ∞
    updateEducationOption() {
      let myDate = new Date();
      let year = Number(myDate.getFullYear());
      let month = Number(myDate.getMonth());
      let options = []
      if (month >= 7) {
        for (let i = year - 3; i <= year - 1; i++) {
          let obj1 = {};
          let obj2 = {};
          let str1 = i + "Á∫ßÊú¨ÁßëÁîü"
          let str2 = i + "Á∫ßÁ†îÁ©∂Áîü"
          obj1["label"] = str1
          obj1["value"] = str1
          options.push(obj1)
          obj2["label"] = str2
          obj2["value"] = str2
          options.push(obj2)
        }
        console.log(options)
      }
      this.educationOptions = options

    },
    //ÂÆâÂÖ®ÊÄßÈ™åËØÅ
    validateSecurity() {
      ucenterApi.validateSecurity(this.validateParams, this.memberInfo.id).then(response => {
        if (response.data.success) {
          this.$message({
            type: 'success',
            message: "Ê†°È™åÊàêÂäüÔºÅ üßô‚Äç‚ôÇÔ∏è"
          })
          this.reload();
        } else {
          this.$message({
            type: 'error',
            message: "Ê†°È™åÂ§±Ë¥•!!!"
          })
        }
      }).catch(error => {
        console.log(error);
      })
    },

    // Êèê‰∫§‰øÆÊîπÊâãÊú∫Âè∑ÊàñÈÇÆÁÆ±‰ø°ÊÅØÁöÑÊñπÊ≥ï
    saveMobileOrEmail(type) {
      if (type === '1') {
        this.emailDialogVisible = false
        this.params.email = ""
      } else if (type === '2') {
        this.mobileDialogVisible = false
        this.params.mobile = ""
      }
      ucenterApi.changeMobileOrEmail(this.params, this.memberInfo.id).then(response => {
        if (response.data.success) {
          this.$message({
            type: 'success',
            message: "‰øÆÊîπÊàêÂäüÔºÅ üßô‚Äç‚ôÇÔ∏è"
          })
          this.reload();
        } else {
          this.$message({
            type: 'error',
            message: "‰øÆÊîπÂ§±Ë¥•!!!"
          })
        }
      }).catch(error => {
        console.log(error);
      })
    },

    //ÁªôÂ∑≤ÁªèËæìÂÖ•ÁöÑÊâãÊú∫Âè∑ÂèëÈÄÅÈ™åËØÅÁ†Å
    getCodeFun(codeType) {
      if (!this.sending) {
        return
      }
      //ÁÇπÂÆåÂèëÈÄÅ  60ÁßíÂÜÖ‰∏çËÆ©ÂÜçÂèë
      if (this.validateMobile || this.validateEmail) {
        this.sending = false
      }
      // debugger;
      if (codeType === "1") {
        if (this.params.mobile !== '') {
          if (this.validateMobile) {
            registerApi.sendCodeByPhone(this.params.mobile)
              .then(response => {
                if (response.data.success) {
                  //ÊèêÁ§∫ÂèëÈÄÅÈ™åËØÅÁ†ÅÊàêÂäü
                  this.$message({
                    type: 'success',
                    message: "È™åËØÅüêéÂ∑≤ÂèëÈÄÅüÜó"
                  })
                  //Ë∞ÉÁî®ÂÄíËÆ°Êó∂ÁöÑÊñπÊ≥ï
                  this.timeDown()
                } else {
                  this.sending = true
                }
              }).catch(error => { //ËØ∑Ê±ÇÂ§±Ë¥•
              //Â¶ÇÊûúÂèëÈÄÅÂ§±Ë¥•,Â∞±ËÆæÁΩÆÂèØ‰ª•ÂèëÈÄÅ
              this.sending = true
              console.log(error)
            })
          }
        } else {
          this.$message({
            type: 'warning',
            message: "ËØ∑ÂÖàËæìÂÖ•ÊâãÊú∫Âè∑"
          })
        }
      } else if (codeType === "2") {
        if (this.params.email !== '') {
          if (this.validateEmail) {
            registerApi.sendCodeByEmail(this.params.email)
              .then(response => {
                if (response.data.success) {
                  //ÊèêÁ§∫ÂèëÈÄÅÈ™åËØÅÁ†ÅÊàêÂäü
                  this.$message({
                    type: 'success',
                    message: "È™åËØÅüêéÂ∑≤ÂèëÈÄÅüÜó"
                  })
                  //Ë∞ÉÁî®ÂÄíËÆ°Êó∂ÁöÑÊñπÊ≥ï
                  this.timeDown()
                } else {
                  this.sending = true
                }
              }).catch(error => { //ËØ∑Ê±ÇÂ§±Ë¥•
              //Â¶ÇÊûúÂèëÈÄÅÂ§±Ë¥•,Â∞±ËÆæÁΩÆÂèØ‰ª•ÂèëÈÄÅ
              this.sending = true
              console.log(error)
            })
          }
        } else {
          this.$message({
            type: 'warning',
            message: "ËØ∑ÂÖàËæìÂÖ•ÈÇÆÁÆ±"
          })
        }
      }
    },

    //ÂÆöÊó∂Âô®  ÂèëÈÄÅÈ™åËØÅÁ†ÅÂÄíÊï∞
    timeDown() {
      let result = setInterval(() => { //setIntervalÂÆöÊó∂Âô®
        --this.second;
        this.codeTest = this.second + "ÁßíÂêéÂèØÂÜçÂèë"
        if (this.second < 1) {
          clearInterval(result);
          this.sending = true;
          this.second = 60;
          this.codeTest = "Ëé∑ÂèñÈ™åËØÅÁ†Å"
        }
      }, 1000);
    },

    saveMsg() {
      // this.memberInfo.education = this.memberInfo.education[1] + this.memberInfo.education[0]
      console.log(this.memberInfo)
      ucenterApi.updateMemberInfo(this.memberInfo)
        .then(response => { //‰øÆÊîπÊàêÂäü
          if (response.data.success) {
            //ÊèêÁ§∫ÊàêÂäü
            this.$message({
              type: 'success',
              message: '‰øÆÊîπÊàêÂäüÔºÅ üßô‚Äç‚ôÇÔ∏è'
            });

            //Êõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØ
            loginApi.getMemberInfoSelf(this.loginInfo.id).then(response => {
              this.memberInfo = response.data.data.memberInfo
              this.loginInfo.nickname = this.memberInfo.nickname
              this.loginInfo.avatar = this.memberInfo.avatar
              let expire = cookie.get("ATAI_BigData_expires_time")
              // Â∞Ü‰øÆÊîπÂêéÁöÑÊï∞ÊçÆÈáçÊñ∞‰øùÂ≠òÂà∞token‰∏≠
              cookie.set("ATAI_BigData_ucenter", this.loginInfo, {expires: new Date(expire)})
              this.reload();
            })

          }
        })
    },

    // Â§¥ÂÉè‰∏ä‰º†ÊàêÂäü
    handleAvatarSuccess(response) {
      if (response.success) {
        this.memberInfo.avatar = response.data.url
        // Âº∫Âà∂ÈáçÊñ∞Ê∏≤Êüì
        this.$forceUpdate()
      } else {
        this.$message.error('‰∏ä‰º†Â§±Ë¥•! ÔºàÈùû20000Ôºâ')
      }
    },

    // Â§¥ÂÉè‰∏ä‰º†Â§±Ë¥•ÔºàhttpÔºâ
    handleAvatarError() {
      this.$message.error('‰∏ä‰º†Â§±Ë¥•! ÔºàhttpÂ§±Ë¥•Ôºâ')
    },

    // ‰∏ä‰º†Ê†°È™å
    beforeAvatarUpload(file) {
      const isJPG = file.type === 'image/jpeg'
      const isPNG = file.type === 'image/png'
      const isLt1M = file.size / 1024 / 1024 < 1

      if (!isJPG && !isPNG) {
        this.$message.error('‰∏ä‰º†Â§¥ÂÉèÂõæÁâáÂè™ËÉΩÊòØ JPG/PNG Ê†ºÂºè!')
      }
      if (!isLt1M) {
        this.$message.error('‰∏ä‰º†Â§¥ÂÉèÂõæÁâáÂ§ßÂ∞è‰∏çËÉΩË∂ÖËøá 1MB!')
      }
      return (isJPG || isPNG) && isLt1M
    },

    //‰ªécookie‰∏≠Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
    showInfoFromCookie() {
      //‰ªécookie‰∏≠Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
      var userStr = cookie.get("ATAI_BigData_ucenter")
      //userStrÊòØÂ≠óÁ¨¶‰∏≤   ÈúÄË¶ÅËΩ¨Êç¢‰∏∫jsonÂØπË±°
      if (userStr) {
        this.loginInfo = JSON.parse(userStr)
        loginApi.getMemberInfoSelf(this.loginInfo.id).then(response => {
          this.memberInfo = response.data.data.memberInfo
        })
      }
    },

    //ÂæÆ‰ø°ÁôªÂΩïÊòæÁ§∫ÁöÑÊñπÊ≥ï
    wxLogin() {
      //ÊäätokenÂÄºÊîæÂà∞cookieÈáåÈù¢
      cookie.set('ATAI_BigData_token', this.token)
      cookie.set('ATAI_BigData_ucenter', '')
      //Ë∞ÉÁî®Êé•Âè£ÔºåÊ†πÊçÆtokenÂÄºËé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
      loginApi.getLoginMemberInfo()
        .then(response => {
          this.loginInfo = response.data.data.userInfo
          cookie.set('ATAI_BigData_ucenter', this.loginInfo)
        })
      loginApi.getMemberInfoSelf(this.loginInfo.id).then(response => {
        this.memberInfo = response.data.data.memberInfo
        cookie.set('ATAI_BigData_ucenter', this.memberInfo)
      })
    },

    checkNickname(rule, value, callback) {
      if (value === '') {
        callback(new Error('Áî®Êà∑Âêç‰∏çËÉΩ‰∏∫Á©∫'));
      } else if (value.length > 16) {
        callback(new Error('Áî®Êà∑ÂêçÈïøÂ∫¶‰∏çÂ∫îË∂ÖËøá16‰∏™Â≠óÁ¨¶'));
      } else {
        ucenterApi.checkNickname(this.memberInfo.nickname).then(response => {
          let flag = response.data.data.flag
          if (flag) {
            callback(new Error('Áî®Êà∑ÂêçÈáçÂ§ç'))
          } else {
            callback()
          }
        })
      }
    },

    //ÊâãÊú∫Âè∑Ê†ºÂºèÊ†°È™å Ëá™ÂÆö‰πâËßÑÂàô
    checkPhone(rule, value, callback) {
      // debugger;
      if (!/^1[34578]\d{9}$/.test(value)) {
        this.validateMobile = false
        return callback(new Error("ÊâãÊú∫Âè∑Á†ÅÊ†ºÂºè‰∏çÊ≠£Á°Æ"));
      } else {
        ucenterApi.checkPhone(this.params.mobile).then(response => {
          let flag = response.data.data.flag
          if (flag) {
            this.validateMobile = false
            callback(new Error('ÊâãÊú∫Âè∑Â∑≤Ë¢´Ê≥®ÂÜå'))
          } else {
            this.validateMobile = true
            callback()
          }
        }).catch(error => {
          console.log(error)
        })
      }
    },

    checkEmail(rule, value, callback) {
      // debugger;
      const mal = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
      if (rule.required && !value) {
        this.validateEmail = false
        return callback(new Error("‰∏çËÉΩ‰∏∫Á©∫"));
      }
      if (value) {
        if (!mal.test(value)) {
          this.validateEmail = false
          callback(new Error("ËØ∑ËæìÂÖ•Ê≠£Á°ÆÈÇÆÁÆ±"));
        } else {
          this.validateEmail = true
          callback();
        }
      }
    },
  }
}
</script>

<style>
.avatar-uploader .el-upload {
  border: 1px dashed #d9d9d9;
  border-radius: 6px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.avatar-uploader .el-upload:hover {
  border-color: #409EFF;
}

.avatar-uploader .avatar-uploader-icon {
  font-size: 28px;
  color: #8c939d;
  width: 178px;
  height: 178px;
  line-height: 178px;
  text-align: center;
}

.avatar-uploader img {
  width: 178px;
  height: 178px;
  display: block;
}

.el-dialog--center .el-dialog__body {
  padding-bottom: 5px;
}
</style>
